<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IPIP-NEO-120 性格テスト - 結果</title>
<style>
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
max-width: 800px;
margin: 0 auto;
padding: 20px;
background-color: #f8f9fa;
line-height: 1.6;
}

.container {
background-color: white;
padding: 30px;
border-radius: 10px;
box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

.header {
text-align: center;
margin-bottom: 30px;
padding-bottom: 20px;
border-bottom: 2px solid #ecf0f1;
}

.header-emoji {
font-size: 36px;
margin-bottom: 10px;
}

.header-title {
font-size: 24px;
color: #2c3e50;
font-weight: bold;
margin-bottom: 10px;
}

.personal-info {
font-size: 14px;
color: #7f8c8d;
margin-bottom: 15px;
}

.results-section {
margin-bottom: 30px;
}

/* 表示切り替えタブ */
.display-tabs {
display: flex;
justify-content: center;
margin-bottom: 30px;
border-bottom: 2px solid #ecf0f1;
}

.tab-button {
background: none;
border: none;
padding: 12px 24px;
cursor: pointer;
font-size: 16px;
font-weight: 500;
color: #7f8c8d;
border-bottom: 3px solid transparent;
transition: all 0.3s ease;
}

.tab-button.active {
color: #3498db;
border-bottom-color: #3498db;
}

.tab-button:hover {
color: #2980b9;
}

.section-title {
font-size: 18px;
font-weight: bold;
color: #2c3e50;
text-align: center;
margin-bottom: 20px;
}

.domain-row {
cursor: pointer;
transition: none;
-webkit-tap-highlight-color: transparent;
}

.domain-row:hover {
background-color: #f8f9fa;
}

.domain-row:focus {
outline: none;
background-color: transparent;
}

.domain-row:active {
background-color: #f8f9fa;
}

.domain-name {
font-weight: 500;
color: #2c3e50;
font-size: 14px;
position: relative;
}

.expand-icon {
font-size: 12px;
color: #7f8c8d;
margin-right: 8px;
transition: transform 0.3s ease;
display: inline-block;
}

.expand-icon.expanded {
transform: rotate(90deg);
}

.domain-description {
display: none;
padding: 8px 15px 12px 15px;
background-color: #fafbfc;
border-top: 1px solid #f1f3f4;
color: #5a6c7d;
font-size: 14px;
line-height: 1.5;
text-align: left;
}

.domain-description.expanded {
display: table-cell;
width: 100%;
}

.score-note {
font-size: 12px;
color: #7f8c8d;
text-align: center;
margin-top: 20px;
padding-top: 15px;
border-top: 1px solid #ecf0f1;
display: none;
}

.score-note.show {
display: block;
}

.results-table {
width: 100%;
border-collapse: collapse;
margin-bottom: 20px;
}

.results-table th {
background-color: #f8f9fa;
padding: 12px;
text-align: center;
border-bottom: 2px solid #dee2e6;
font-weight: bold;
color: #495057;
}

.results-table td {
padding: 12px;
border-bottom: 1px solid #dee2e6;
}

.domain-name {
font-weight: 500;
color: #2c3e50;
font-size: 14px;
}

.t-score {
font-weight: bold;
font-size: 16px;
text-align: center;
}

.evaluation {
text-align: center;
}

.evaluation-label {
font-weight: 500;
padding: 4px 8px;
border-radius: 15px;
font-size: 12px;
}

.very-high { background-color: #e74c3c; color: white; }
.high { background-color: #f39c12; color: white; }
.somewhat-high { background-color: #f1c40f; color: #2c3e50; }
.average { background-color: #95a5a6; color: white; }
.somewhat-low { background-color: #3498db; color: white; }
.low { background-color: #2980b9; color: white; }
.very-low { background-color: #8e44ad; color: white; }

.percentile {
font-size: 12px;
color: #7f8c8d;
}

.action-buttons {
text-align: center;
margin-top: 30px;
}

.btn {
background-color: #3498db;
color: white;
border: none;
padding: 12px 24px;
border-radius: 5px;
cursor: pointer;
font-size: 16px;
margin: 5px 0;
text-decoration: none;
display: block;
width: 100%;
max-width: 200px;
margin-left: auto;
margin-right: auto;
text-align: center;
box-sizing: border-box;
}

.btn:hover {
background-color: #2980b9;
}

/* PC表示時のボタンスタイル */
@media (min-width: 601px) {
.btn {
    display: inline-block;
    width: auto;
    min-width: 140px;
    margin: 0 10px;
}
}

/* レスポンシブ */
@media (max-width: 600px) {
body {
    padding: 10px;
}

.container {
    padding: 20px;
}

.results-table {
    font-size: 14px;
}

.results-table th,
.results-table td {
    padding: 8px 6px;
}

.domain-name {
    font-size: 13px;
}
}

/* デバッグエリアを非表示 */
.debug-area {
display: none;
}
</style>
</head>
<body>
<div class="container">
<!-- ヘッダー -->
<div class="header">
<div class="header-emoji">🧠</div>
<div class="header-title">分析結果</div>
<div class="personal-info" id="personal-info">
    <!-- JavaScript で動的に設定 -->
</div>
</div>

<!-- 表示切り替えタブ -->
<div class="display-tabs">
<button class="tab-button active" onclick="switchDisplayMode('tscore')" id="tscore-tab">偏差値</button>
<button class="tab-button" onclick="switchDisplayMode('raw')" id="raw-tab">得点</button>
</div>

<!-- 結果表示エリア -->
<div class="results-section">
<div class="section-title">5つの性格領域</div>

<table class="results-table">
    <thead>
        <tr>
            <th style="text-align: left; width: 40%;">領域</th>
            <th style="width: 20%;" id="score-header">偏差値</th>
            <th style="width: 40%;">評価</th>
        </tr>
    </thead>
    <tbody id="domain-results">
        <!-- JavaScript で動的に生成 -->
    </tbody>
</table>
</div>

<!-- 注釈 -->
<div class="score-note" id="score-note">
※5領域は120点満点
</div>

<!-- アクション -->
<div class="action-buttons">
<a href="detailed-results.html" class="btn">詳細を見る</a>
<button class="btn btn-restart" onclick="confirmReturnToStart()">ホームに戻る</button>
</div>

<!-- デバッグエリア（非表示） -->
<div class="debug-area">
<div class="debug-title">デバッグ情報</div>
<div class="debug-content" id="debug-content">結果画面を読み込み中...</div>
</div>
</div>

<!-- 採点システム読み込み -->
<script src="scoring.js"></script>

<script>
// グローバル変数
let scoringSystem = null;
let results = null;
let personalInfo = null;
let currentDisplayMode = 'tscore'; // 'tscore' or 'raw'

// 領域説明文データ
const domainDescriptions = {
'Neuroticism': 'ストレスや感情への敏感さ。高いと繊細で共感力に優れ危険察知が得意、低いと冷静沈着でプレッシャーに強い。',
'Extraversion': '社交性と活動エネルギー。高いと人との交流からエネルギーを得る、低いと一人時間で充電する。',
'Openness': '新しさや創造性への関心。高いと革新的で変化を歓迎、低いと伝統的で確実性を重視する。',
'Agreeableness': '他人への思いやりと協力姿勢。高いと人との調和を重視、低いと客観的で競争的、合理的判断ができる。',
'Conscientiousness': '計画性と責任遂行力。高いと目標達成型で信頼される、低いと柔軟性があり自由な発想を持つ。'
};

// デバッグログ（機能は残すが非表示）
function debugLog(message) {
const debugContent = document.getElementById('debug-content');
if (debugContent) {
    const timestamp = new Date().toLocaleTimeString();
    debugContent.textContent += `[${timestamp}] ${message}\n`;
    debugContent.scrollTop = debugContent.scrollHeight;
}
console.log(`[DEBUG] ${message}`);
}

// 初期化
async function initialize() {
debugLog('結果画面を初期化中...');

try {
    // 個人情報を読み込み
    loadPersonalInfo();
    
    // データファイルを読み込み
    await loadData();
    
    // 回答データを読み込み
    const answers = loadAnswers();
    
    // 採点実行
    calculateResults(answers);
    
    // 結果表示
    displayResults();
    
    debugLog('✅ 初期化完了');
    
} catch (error) {
    debugLog(`❌ 初期化エラー: ${error.message}`);
    alert('結果の計算に失敗しました。テストをやり直してください。');
    window.location.href = 'index.html';
}
}

// 個人情報読み込み
function loadPersonalInfo() {
try {
    const stored = localStorage.getItem('ipip-neo-personal-info');
    if (stored) {
        personalInfo = JSON.parse(stored);
        debugLog(`個人情報読み込み: ${personalInfo.gender}, ${personalInfo.age}歳, ${personalInfo.nationality}`);
    } else {
        debugLog('個人情報が見つかりません');
        personalInfo = {
            gender: '男性',
            age: 32,
            nationality: '日本'
        };
    }
} catch (error) {
    debugLog(`個人情報読み込みエラー: ${error.message}`);
    personalInfo = { gender: '不明', age: 0, nationality: '不明' };
}
}

// データファイル読み込み
async function loadData() {
debugLog('データファイルを読み込み中...');

// questions.json
const questionsResponse = await fetch('./data/questions.json');
if (!questionsResponse.ok) {
    throw new Error(`questions.json読み込みエラー: ${questionsResponse.status}`);
}
const questionsData = await questionsResponse.json();

// norms.json
const normsResponse = await fetch('./data/norms.json');
if (!normsResponse.ok) {
    throw new Error(`norms.json読み込みエラー: ${normsResponse.status}`);
}
const normsData = await normsResponse.json();

// 採点システム初期化
scoringSystem = new IPIPNEOScoring(normsData, questionsData);

debugLog('データファイル読み込み完了');
}

// 回答データ読み込み
function loadAnswers() {
try {
    // 完了データから読み込み
    const stored = localStorage.getItem('ipip-neo-answers-completed');
    if (stored) {
        const answers = JSON.parse(stored);
        debugLog(`完了回答データ読み込み: ${answers.length}問`);
        
        // 120問完全かチェック
        const validAnswers = answers.filter(a => a >= 1 && a <= 5).length;
        if (validAnswers < 120) {
            throw new Error(`回答不完全: ${validAnswers}/120問`);
        }
        
        return answers;
    } else {
        throw new Error('完了した回答データが見つかりません');
    }
} catch (error) {
    debugLog(`回答読み込みエラー: ${error.message}`);
    // テスト用ランダムデータ
    debugLog('テスト用ランダムデータを生成');
    return new Array(120).fill(0).map(() => Math.floor(Math.random() * 5) + 1);
}
}

// 採点実行
function calculateResults(answers) {
debugLog('採点を実行中...');

try {
    results = scoringSystem.calculateFullResults(answers);
    debugLog('✅ 採点完了');
    debugLog(`領域T得点: ${Object.keys(results.tScores.domains).length}個`);
    debugLog(`側面T得点: ${Object.keys(results.tScores.facets).length}個`);
    
} catch (error) {
    debugLog(`❌ 採点エラー: ${error.message}`);
    throw error;
}
}

// 結果表示
function displayResults() {
debugLog('結果を表示中...');

// 個人情報表示
displayPersonalInfo();

// 領域結果表示
displayDomainResults();

debugLog('✅ 結果表示完了');
}

// 個人情報表示
function displayPersonalInfo() {
const personalInfoElement = document.getElementById('personal-info');
personalInfoElement.textContent = `性別: ${personalInfo.gender} / 年齢: ${personalInfo.age}歳 / 国籍: ${personalInfo.nationality}`;
}

// 領域結果表示
function displayDomainResults() {
const tbody = document.getElementById('domain-results');
tbody.innerHTML = '';

// 領域の順序を定義（表示順）
const domainOrder = [
    'Neuroticism',
    'Extraversion', 
    'Openness',
    'Agreeableness',
    'Conscientiousness'
];

domainOrder.forEach(domainKey => {
    const tScore = results.tScores.domains[domainKey];
    const rawScore = results.rawScores.domains[domainKey];
    const evaluation = results.evaluations.domains[domainKey];
    const percentile = results.percentiles.domains[domainKey];
    const domainName = scoringSystem.norms.domains[domainKey].japanese_name;
    
    const row = document.createElement('tr');
    row.className = 'domain-row';
    row.onclick = () => toggleDomainDescription(row, domainKey);
    
    // 領域名
    const nameCell = document.createElement('td');
    nameCell.className = 'domain-name';
    
    // 展開アイコンを追加
    const expandIcon = document.createElement('span');
    expandIcon.className = 'expand-icon';
    expandIcon.textContent = '▶';
    
    const nameText = document.createElement('span');
    nameText.textContent = domainName;
    
    nameCell.appendChild(expandIcon);
    nameCell.appendChild(nameText);
    
    // 得点
    const scoreCell = document.createElement('td');
    scoreCell.className = 't-score';
    scoreCell.setAttribute('data-domain-key', domainKey);
    updateDomainScore(scoreCell, domainKey);
    
    // 評価
    const evalCell = document.createElement('td');
    evalCell.className = 'evaluation';
    
    const evalLabel = document.createElement('span');
    evalLabel.className = `evaluation-label ${getEvaluationClass(evaluation.label)}`;
    evalLabel.textContent = evaluation.label;
    
    const percentileText = document.createElement('div');
    percentileText.className = 'percentile';
    percentileText.textContent = `（${percentile.displayText}）`;
    
    evalCell.appendChild(evalLabel);
    evalCell.appendChild(percentileText);
    
    row.appendChild(nameCell);
    row.appendChild(scoreCell);
    row.appendChild(evalCell);
    
    tbody.appendChild(row);
    
    // 説明文行を追加（3列にまたがる）
    const descRow = document.createElement('tr');
    const descCell = document.createElement('td');
    descCell.colSpan = 3; // 3列すべてにまたがる
    descCell.className = 'domain-description';
    descCell.textContent = domainDescriptions[domainKey] || '説明文が見つかりません。';
    descRow.appendChild(descCell);
    tbody.appendChild(descRow);
});
}

// 表示モード切り替え
function switchDisplayMode(mode) {
currentDisplayMode = mode;

// タブの状態更新
document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active');
});
document.getElementById(`${mode}-tab`).classList.add('active');

// ヘッダー更新
const scoreHeader = document.getElementById('score-header');
if (mode === 'tscore') {
    scoreHeader.textContent = '偏差値';
} else {
    scoreHeader.textContent = '得点';
}

// 注釈の表示制御
const scoreNote = document.getElementById('score-note');
if (mode === 'raw') {
    scoreNote.classList.add('show');
} else {
    scoreNote.classList.remove('show');
}

// 全ての得点表示を更新
updateAllDomainScores();

debugLog(`表示モードを${mode}に切り替え`);
}

// 全領域得点更新
function updateAllDomainScores() {
document.querySelectorAll('.t-score[data-domain-key]').forEach(element => {
    const domainKey = element.getAttribute('data-domain-key');
    updateDomainScore(element, domainKey);
});
}

// 領域得点更新
function updateDomainScore(element, domainKey) {
const tScore = results.tScores.domains[domainKey];
const rawScore = results.rawScores.domains[domainKey];

if (currentDisplayMode === 'tscore') {
    element.textContent = tScore;
} else {
    element.textContent = rawScore;
}
}

// 領域説明の展開/折りたたみ
function toggleDomainDescription(row, domainKey) {
const descRow = row.nextElementSibling;
const descCell = descRow.querySelector('.domain-description');
const expandIcon = row.querySelector('.expand-icon');

if (descCell.classList.contains('expanded')) {
    descCell.classList.remove('expanded');
    row.classList.remove('expanded');
    if (expandIcon) {
        expandIcon.classList.remove('expanded');
    }
} else {
    descCell.classList.add('expanded');
    row.classList.add('expanded');
    if (expandIcon) {
        expandIcon.classList.add('expanded');
    }
}
}

// 評価ラベルのCSSクラスを取得
function getEvaluationClass(label) {
const classMap = {
    '非常に高い': 'very-high',
    '高い': 'high',
    'やや高い': 'somewhat-high',
    '平均': 'average',
    'やや低い': 'somewhat-low',
    '低い': 'low',
    '非常に低い': 'very-low'
};
return classMap[label] || 'average';
}

// 確認付きで最初に戻る
function confirmReturnToStart() {
const confirmed = confirm('本当にホーム画面に戻りますか？');
if (confirmed) {
    window.location.href = 'index.html';
}
}

// ページ読み込み時に初期化
window.addEventListener('load', initialize);
</script>
</body>
</html>