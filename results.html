<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IPIP-NEO-120 æ€§æ ¼ãƒ†ã‚¹ãƒˆ - çµæœ</title>
<style>
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
max-width: 800px;
margin: 0 auto;
padding: 20px;
background-color: #f8f9fa;
line-height: 1.6;
}

.container {
background-color: white;
padding: 30px;
border-radius: 10px;
box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

.header {
text-align: center;
margin-bottom: 30px;
padding-bottom: 20px;
border-bottom: 2px solid #ecf0f1;
}

.header-emoji {
font-size: 36px;
margin-bottom: 10px;
}

.header-title {
font-size: 24px;
color: #2c3e50;
font-weight: bold;
margin-bottom: 10px;
}

.personal-info {
font-size: 14px;
color: #7f8c8d;
margin-bottom: 15px;
}

.results-section {
margin-bottom: 30px;
}

/* è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– */
.display-tabs {
display: flex;
justify-content: center;
margin-bottom: 30px;
border-bottom: 2px solid #ecf0f1;
}

.tab-button {
background: none;
border: none;
padding: 12px 24px;
cursor: pointer;
font-size: 16px;
font-weight: 500;
color: #7f8c8d;
border-bottom: 3px solid transparent;
transition: all 0.3s ease;
}

.tab-button.active {
color: #3498db;
border-bottom-color: #3498db;
}

.tab-button:hover {
color: #2980b9;
}

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä¸­å¤®æƒãˆã« */
.section-title {
font-size: 18px;
font-weight: bold;
color: #2c3e50;
text-align: center;
margin-bottom: 20px;
}

/* é ˜åŸŸè¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«å¼·åŒ– */
.domain-row {
cursor: pointer;
transition: none;
-webkit-tap-highlight-color: transparent;
}

.domain-row:hover {
background-color: #f8f9fa;
}

.domain-row:focus {
outline: none;
background-color: transparent;
}

.domain-row:active {
background-color: #f8f9fa;
}

.domain-name {
font-weight: 500;
color: #2c3e50;
font-size: 14px; /* é ˜åŸŸåã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã */
position: relative;
}

.expand-icon {
font-size: 12px;
color: #7f8c8d;
margin-right: 8px;
transition: transform 0.3s ease;
display: inline-block;
}

.expand-icon.expanded {
transform: rotate(90deg);
}

.domain-description {
display: none;
padding: 8px 15px 12px 15px;
background-color: #fafbfc;
border-top: 1px solid #f1f3f4;
color: #5a6c7d;
font-size: 14px;
line-height: 1.5;
text-align: left;
}

.domain-description.expanded {
display: table-cell; /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚»ãƒ«è¡¨ç¤ºã§æ¨ªå¹…ã„ã£ã±ã„ */
width: 100%;
}

/* æ³¨é‡ˆ */
.score-note {
font-size: 12px;
color: #7f8c8d;
text-align: center;
margin-top: 20px;
padding-top: 15px;
border-top: 1px solid #ecf0f1;
display: none;
}

.score-note.show {
display: block;
}

.results-table {
width: 100%;
border-collapse: collapse;
margin-bottom: 20px;
}

.results-table th {
background-color: #f8f9fa;
padding: 12px;
text-align: center;
border-bottom: 2px solid #dee2e6;
font-weight: bold;
color: #495057;
}

.results-table td {
padding: 12px;
border-bottom: 1px solid #dee2e6;
}

.domain-name {
font-weight: 500;
color: #2c3e50;
font-size: 14px; /* é ˜åŸŸåã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã */
}

.t-score {
font-weight: bold;
font-size: 16px;
text-align: center;
}

.evaluation {
text-align: center;
}

.evaluation-label {
font-weight: 500;
padding: 4px 8px;
border-radius: 15px;
font-size: 12px;
}

.very-high { background-color: #e74c3c; color: white; }
.high { background-color: #f39c12; color: white; }
.somewhat-high { background-color: #f1c40f; color: #2c3e50; }
.average { background-color: #95a5a6; color: white; }
.somewhat-low { background-color: #3498db; color: white; }
.low { background-color: #2980b9; color: white; }
.very-low { background-color: #8e44ad; color: white; }

.percentile {
font-size: 12px;
color: #7f8c8d;
}

.action-buttons {
text-align: center;
margin-top: 30px;
}

.btn {
background-color: #3498db;
color: white;
border: none;
padding: 12px 24px;
border-radius: 5px;
cursor: pointer;
font-size: 16px;
margin: 5px 0;
text-decoration: none;
display: block;
width: 100%;
max-width: 200px;
margin-left: auto;
margin-right: auto;
text-align: center;
box-sizing: border-box;
}

.btn:hover {
background-color: #2980b9;
}

.btn-restart {
background-color: #95a5a6;
color: white;
}

.btn-restart:hover {
background-color: #7f8c8d;
}

/* PCè¡¨ç¤ºæ™‚ã®ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
@media (min-width: 601px) {
.btn {
    display: inline-block;
    width: auto;
    min-width: 140px;
    margin: 0 10px;
}
}

/* ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒªã‚¢ */
.debug-area {
margin-top: 30px;
padding: 15px;
background-color: #f8f9fa;
border-radius: 5px;
border: 1px solid #dee2e6;
}

.debug-title {
font-weight: bold;
color: #6c757d;
margin-bottom: 10px;
font-size: 14px;
}

.debug-content {
font-family: monospace;
font-size: 12px;
background-color: white;
padding: 10px;
border-radius: 3px;
white-space: pre-wrap;
max-height: 200px;
overflow-y: auto;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 600px) {
body {
    padding: 10px;
}

.container {
    padding: 20px;
}

.results-table {
    font-size: 14px;
}

.results-table th,
.results-table td {
    padding: 8px 6px;
}

.action-buttons {
    flex-direction: column;
}

.btn {
    display: block;
    margin: 5px auto;
    width: 100%;
    max-width: none;
}

.domain-name {
    font-size: 13px; /* ã‚¹ãƒãƒ›ã§ã¯ã•ã‚‰ã«å°ã•ã */
}
}
</style>
</head>
<body>
<div class="container">
<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<div class="header">
<div class="header-emoji">ğŸ§ </div>
<div class="header-title">åˆ†æçµæœ</div>
<div class="personal-info" id="personal-info">
    <!-- JavaScript ã§å‹•çš„ã«è¨­å®š -->
</div>
</div>

<!-- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– -->
<div class="display-tabs">
<button class="tab-button active" onclick="switchDisplayMode('tscore')" id="tscore-tab">åå·®å€¤</button>
<button class="tab-button" onclick="switchDisplayMode('raw')" id="raw-tab">å¾—ç‚¹</button>
</div>

<!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div class="results-section">
<div class="section-title">5ã¤ã®æ€§æ ¼é ˜åŸŸ</div>

<table class="results-table">
    <thead>
        <tr>
            <th style="text-align: left; width: 40%;">é ˜åŸŸ</th>
            <th style="width: 20%;" id="score-header">åå·®å€¤</th>
            <th style="width: 40%;">è©•ä¾¡</th>
        </tr>
    </thead>
    <tbody id="domain-results">
        <!-- JavaScript ã§å‹•çš„ã«ç”Ÿæˆ -->
    </tbody>
</table>
</div>

<!-- æ³¨é‡ˆ -->
<div class="score-note" id="score-note">
â€»5é ˜åŸŸã¯120ç‚¹æº€ç‚¹
</div>

<!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="action-buttons">
<a href="detailed-results.html" class="btn">è©³ç´°ã‚’è¦‹ã‚‹</a>
<button class="btn" onclick="copyResults()">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
</div>

<div class="action-buttons" style="margin-top: 20px;">
<button class="btn btn-restart" onclick="confirmReturnToStart()">ãƒ†ã‚¹ãƒˆã‚’ã‚„ã‚Šç›´ã™</button>
</div>

<!-- ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒªã‚¢ -->
<div class="debug-area">
<div class="debug-title">ãƒ‡ãƒãƒƒã‚°æƒ…å ±</div>
<div class="debug-content" id="debug-content">çµæœç”»é¢ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
</div>
</div>

<!-- æ¡ç‚¹ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿ -->
<script src="scoring.js"></script>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let scoringSystem = null;
let results = null;
let personalInfo = null;
let currentDisplayMode = 'tscore'; // 'tscore' or 'raw'

// é ˜åŸŸèª¬æ˜æ–‡ãƒ‡ãƒ¼ã‚¿
const domainDescriptions = {
'Neuroticism': 'ã‚¹ãƒˆãƒ¬ã‚¹ã‚„æ„Ÿæƒ…ã¸ã®æ•æ„Ÿã•ã€‚é«˜ã„ã¨ç¹Šç´°ã§å…±æ„ŸåŠ›ã«å„ªã‚Œå±é™ºå¯ŸçŸ¥ãŒå¾—æ„ã€ä½ã„ã¨å†·é™æ²ˆç€ã§ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã«å¼·ã„ã€‚',
'Extraversion': 'ç¤¾äº¤æ€§ã¨æ´»å‹•ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚é«˜ã„ã¨äººã¨ã®äº¤æµã‹ã‚‰ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’å¾—ã‚‹ã€ä½ã„ã¨ä¸€äººæ™‚é–“ã§å……é›»ã™ã‚‹ã€‚',
'Openness': 'æ–°ã—ã•ã‚„å‰µé€ æ€§ã¸ã®é–¢å¿ƒã€‚é«˜ã„ã¨é©æ–°çš„ã§å¤‰åŒ–ã‚’æ­“è¿ã€ä½ã„ã¨ä¼çµ±çš„ã§ç¢ºå®Ÿæ€§ã‚’é‡è¦–ã™ã‚‹ã€‚',
'Agreeableness': 'ä»–äººã¸ã®æ€ã„ã‚„ã‚Šã¨å”åŠ›å§¿å‹¢ã€‚é«˜ã„ã¨äººã¨ã®èª¿å’Œã‚’é‡è¦–ã€ä½ã„ã¨å®¢è¦³çš„ã§ç«¶äº‰çš„ã€åˆç†çš„åˆ¤æ–­ãŒã§ãã‚‹ã€‚',
'Conscientiousness': 'è¨ˆç”»æ€§ã¨è²¬ä»»é‚è¡ŒåŠ›ã€‚é«˜ã„ã¨ç›®æ¨™é”æˆå‹ã§ä¿¡é ¼ã•ã‚Œã‚‹ã€ä½ã„ã¨æŸ”è»Ÿæ€§ãŒã‚ã‚Šè‡ªç”±ãªç™ºæƒ³ã‚’æŒã¤ã€‚'
};

// ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
function debugLog(message) {
const debugContent = document.getElementById('debug-content');
const timestamp = new Date().toLocaleTimeString();
debugContent.textContent += `[${timestamp}] ${message}\n`;
debugContent.scrollTop = debugContent.scrollHeight;
}

// åˆæœŸåŒ–
async function initialize() {
debugLog('çµæœç”»é¢ã‚’åˆæœŸåŒ–ä¸­...');

try {
    // å€‹äººæƒ…å ±ã‚’èª­ã¿è¾¼ã¿
    loadPersonalInfo();
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
    await loadData();
    
    // å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    const answers = loadAnswers();
    
    // æ¡ç‚¹å®Ÿè¡Œ
    calculateResults(answers);
    
    // çµæœè¡¨ç¤º
    displayResults();
    
    debugLog('âœ… åˆæœŸåŒ–å®Œäº†');
    
} catch (error) {
    debugLog(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    alert('çµæœã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ†ã‚¹ãƒˆã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚');
    // window.location.href = 'index.html';
}
}

// å€‹äººæƒ…å ±èª­ã¿è¾¼ã¿
function loadPersonalInfo() {
try {
    const stored = localStorage.getItem('ipip-neo-personal-info');
    if (stored) {
        personalInfo = JSON.parse(stored);
        debugLog(`å€‹äººæƒ…å ±èª­ã¿è¾¼ã¿: ${personalInfo.gender}, ${personalInfo.age}æ­³, ${personalInfo.nationality}`);
    } else {
        debugLog('å€‹äººæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        // ãƒ†ã‚¹ãƒˆç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
        personalInfo = {
            gender: 'ç”·æ€§',
            age: 32,
            nationality: 'æ—¥æœ¬'
        };
    }
} catch (error) {
    debugLog(`å€‹äººæƒ…å ±èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    personalInfo = { gender: 'ä¸æ˜', age: 0, nationality: 'ä¸æ˜' };
}
}

// ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
async function loadData() {
debugLog('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');

// questions.json
const questionsResponse = await fetch('./data/questions.json');
if (!questionsResponse.ok) {
    throw new Error(`questions.jsonèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${questionsResponse.status}`);
}
const questionsData = await questionsResponse.json();

// norms.json
const normsResponse = await fetch('./data/norms.json');
if (!normsResponse.ok) {
    throw new Error(`norms.jsonèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${normsResponse.status}`);
}
const normsData = await normsResponse.json();

// æ¡ç‚¹ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
scoringSystem = new IPIPNEOScoring(normsData, questionsData);

debugLog('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
}

// å›ç­”ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
function loadAnswers() {
try {
    const stored = localStorage.getItem('ipip-neo-answers');
    if (stored) {
        const answers = JSON.parse(stored);
        debugLog(`å›ç­”ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿: ${answers.length}å•`);
        
        // 120å•å®Œå…¨ã‹ãƒã‚§ãƒƒã‚¯
        const validAnswers = answers.filter(a => a >= 1 && a <= 5).length;
        if (validAnswers < 120) {
            throw new Error(`å›ç­”ä¸å®Œå…¨: ${validAnswers}/120å•`);
        }
        
        return answers;
    } else {
        throw new Error('å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
} catch (error) {
    debugLog(`å›ç­”èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    // ãƒ†ã‚¹ãƒˆç”¨ãƒ©ãƒ³ãƒ€ãƒ ãƒ‡ãƒ¼ã‚¿
    debugLog('ãƒ†ã‚¹ãƒˆç”¨ãƒ©ãƒ³ãƒ€ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ');
    return new Array(120).fill(0).map(() => Math.floor(Math.random() * 5) + 1);
}
}

// æ¡ç‚¹å®Ÿè¡Œ
function calculateResults(answers) {
debugLog('æ¡ç‚¹ã‚’å®Ÿè¡Œä¸­...');

try {
    results = scoringSystem.calculateFullResults(answers);
    debugLog('âœ… æ¡ç‚¹å®Œäº†');
    debugLog(`é ˜åŸŸTå¾—ç‚¹: ${Object.keys(results.tScores.domains).length}å€‹`);
    debugLog(`å´é¢Tå¾—ç‚¹: ${Object.keys(results.tScores.facets).length}å€‹`);
    
    // è©³ç´°ãƒ‡ãƒãƒƒã‚°æƒ…å ±
    debugDetailedScoring(answers);
    
} catch (error) {
    debugLog(`âŒ æ¡ç‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    throw error;
}
}

// è©³ç´°æ¡ç‚¹ãƒ‡ãƒãƒƒã‚°
function debugDetailedScoring(answers) {
debugLog('\n=== ğŸ“Š å®Œå…¨æ¡ç‚¹ãƒ‡ãƒãƒƒã‚°åˆ†æ ===');

// 1. å…¨30å´é¢ã®è©³ç´°åˆ†æ
debugFacetAnalysis(answers);

// 2. é ˜åŸŸåˆè¨ˆã®ç¢ºèª
debugDomainAnalysis();

// 3. Tå¾—ç‚¹è¨ˆç®—ã®ç¢ºèª
debugTScoreAnalysis();
}

// å´é¢åˆ†æï¼ˆå…¨30å´é¢ï¼‰
function debugFacetAnalysis(answers) {
debugLog('\nğŸ” å…¨30å´é¢ã®è©³ç´°åˆ†æ:');

const facetQuestions = {};

// å„è³ªå•ãŒã©ã®å´é¢ã«å±ã™ã‚‹ã‹ãƒãƒƒãƒ”ãƒ³ã‚°
scoringSystem.questions.forEach((q, i) => {
    if (!facetQuestions[q.facet]) {
        facetQuestions[q.facet] = [];
    }
    facetQuestions[q.facet].push({
        questionNum: i + 1,
        answer: answers[i],
        keying: q.keying,
        score: q.keying === 'positive' ? answers[i] : (6 - answers[i])
    });
});

// å„å´é¢ã®è©³ç´°è¡¨ç¤º
Object.entries(facetQuestions).forEach(([facetName, questions]) => {
    const actualScore = results.rawScores.facets[facetName];
    const expectedScore = questions.reduce((sum, q) => sum + q.score, 0);
    const match = actualScore === expectedScore ? 'âœ…' : 'âŒ';
    
    debugLog(`\n${match} ${facetName}: å®Ÿéš›${actualScore}ç‚¹ / æœŸå¾…${expectedScore}ç‚¹`);
    
    if (actualScore !== expectedScore) {
        debugLog(`  è©³ç´°:`);
        questions.forEach(q => {
            debugLog(`    Q${q.questionNum}: å›ç­”${q.answer} (${q.keying}) â†’ ${q.score}ç‚¹`);
        });
    }
    
    // è³ªå•æ•°ç¢ºèª
    if (questions.length !== 4) {
        debugLog(`  âš ï¸ è³ªå•æ•°ç•°å¸¸: ${questions.length}å•ï¼ˆæœŸå¾…4å•ï¼‰`);
    }
});
}

// é ˜åŸŸåˆ†æ
function debugDomainAnalysis() {
debugLog('\nğŸ” 5é ˜åŸŸã®åˆè¨ˆåˆ†æ:');

Object.entries(scoringSystem.domainMapping).forEach(([domainName, facetNames]) => {
    const actualScore = results.rawScores.domains[domainName];
    const expectedScore = facetNames.reduce((sum, facetName) => {
        return sum + (results.rawScores.facets[facetName] || 0);
    }, 0);
    const match = actualScore === expectedScore ? 'âœ…' : 'âŒ';
    const domainJP = scoringSystem.norms.domains[domainName].japanese_name;
    
    debugLog(`${match} ${domainJP}: å®Ÿéš›${actualScore}ç‚¹ / æœŸå¾…${expectedScore}ç‚¹`);
    
    if (actualScore !== expectedScore) {
        debugLog(`  å´é¢å†…è¨³:`);
        facetNames.forEach(facetName => {
            const facetScore = results.rawScores.facets[facetName] || 0;
            debugLog(`    ${facetName}: ${facetScore}ç‚¹`);
        });
    }
});
}

// Tå¾—ç‚¹åˆ†æ
function debugTScoreAnalysis() {
debugLog('\nğŸ” Tå¾—ç‚¹è¨ˆç®—ç¢ºèª:');

Object.entries(results.rawScores.domains).forEach(([domainName, rawScore]) => {
    const norm = scoringSystem.norms.domains[domainName];
    const actualTScore = results.tScores.domains[domainName];
    const expectedTScore = Math.round((50 + (10 * (rawScore - norm.mean) / norm.sd)) * 10) / 10;
    const match = Math.abs(actualTScore - expectedTScore) < 0.1 ? 'âœ…' : 'âŒ';
    const domainJP = norm.japanese_name;
    
    debugLog(`${match} ${domainJP}:`);
    debugLog(`  ç”Ÿå¾—ç‚¹: ${rawScore}ç‚¹`);
    debugLog(`  å¹³å‡: ${norm.mean}, SD: ${norm.sd}`);
    debugLog(`  è¨ˆç®—: 50 + 10Ã—(${rawScore}-${norm.mean})/${norm.sd} = ${expectedTScore}`);
    debugLog(`  å®Ÿéš›: ${actualTScore}, æœŸå¾…: ${expectedTScore}`);
});
}

// çµæœè¡¨ç¤º
function displayResults() {
debugLog('çµæœã‚’è¡¨ç¤ºä¸­...');

// å€‹äººæƒ…å ±è¡¨ç¤º
displayPersonalInfo();

// é ˜åŸŸçµæœè¡¨ç¤º
displayDomainResults();

debugLog('âœ… çµæœè¡¨ç¤ºå®Œäº†');
}

// å€‹äººæƒ…å ±è¡¨ç¤º
function displayPersonalInfo() {
const personalInfoElement = document.getElementById('personal-info');
personalInfoElement.textContent = `æ€§åˆ¥: ${personalInfo.gender} / å¹´é½¢: ${personalInfo.age}æ­³ / å›½ç±: ${personalInfo.nationality}`;
}

// é ˜åŸŸçµæœè¡¨ç¤º
function displayDomainResults() {
const tbody = document.getElementById('domain-results');
tbody.innerHTML = '';

// é ˜åŸŸã®é †åºã‚’å®šç¾©ï¼ˆè¡¨ç¤ºé †ï¼‰
const domainOrder = [
    'Neuroticism',
    'Extraversion', 
    'Openness',
    'Agreeableness',
    'Conscientiousness'
];

domainOrder.forEach(domainKey => {
    const tScore = results.tScores.domains[domainKey];
    const rawScore = results.rawScores.domains[domainKey];
    const evaluation = results.evaluations.domains[domainKey];
    const percentile = results.percentiles.domains[domainKey];
    const domainName = scoringSystem.norms.domains[domainKey].japanese_name;
    
    const row = document.createElement('tr');
    row.className = 'domain-row';
    row.onclick = () => toggleDomainDescription(row, domainKey);
    
    // é ˜åŸŸå
    const nameCell = document.createElement('td');
    nameCell.className = 'domain-name';
    
    // å±•é–‹ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
    const expandIcon = document.createElement('span');
    expandIcon.className = 'expand-icon';
    expandIcon.textContent = 'â–¶';
    
    const nameText = document.createElement('span');
    nameText.textContent = domainName;
    
    nameCell.appendChild(expandIcon);
    nameCell.appendChild(nameText);
    
    // å¾—ç‚¹
    const scoreCell = document.createElement('td');
    scoreCell.className = 't-score';
    scoreCell.setAttribute('data-domain-key', domainKey);
    updateDomainScore(scoreCell, domainKey);
    
    // è©•ä¾¡
    const evalCell = document.createElement('td');
    evalCell.className = 'evaluation';
    
    const evalLabel = document.createElement('span');
    evalLabel.className = `evaluation-label ${getEvaluationClass(evaluation.label)}`;
    evalLabel.textContent = evaluation.label;
    
    const percentileText = document.createElement('div');
    percentileText.className = 'percentile';
    percentileText.textContent = `ï¼ˆ${percentile.displayText}ï¼‰`;
    
    evalCell.appendChild(evalLabel);
    evalCell.appendChild(percentileText);
    
    row.appendChild(nameCell);
    row.appendChild(scoreCell);
    row.appendChild(evalCell);
    
    tbody.appendChild(row);
    
    // èª¬æ˜æ–‡è¡Œã‚’è¿½åŠ ï¼ˆ3åˆ—ã«ã¾ãŸãŒã‚‹ï¼‰
    const descRow = document.createElement('tr');
    const descCell = document.createElement('td');
    descCell.colSpan = 3; // 3åˆ—ã™ã¹ã¦ã«ã¾ãŸãŒã‚‹
    descCell.className = 'domain-description';
    descCell.textContent = domainDescriptions[domainKey] || 'èª¬æ˜æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
    descRow.appendChild(descCell);
    tbody.appendChild(descRow);
});
}

// è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
function switchDisplayMode(mode) {
currentDisplayMode = mode;

// ã‚¿ãƒ–ã®çŠ¶æ…‹æ›´æ–°
document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active');
});
document.getElementById(`${mode}-tab`).classList.add('active');

// ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
const scoreHeader = document.getElementById('score-header');
if (mode === 'tscore') {
    scoreHeader.textContent = 'åå·®å€¤';
} else {
    scoreHeader.textContent = 'å¾—ç‚¹';
}

// æ³¨é‡ˆã®è¡¨ç¤ºåˆ¶å¾¡
const scoreNote = document.getElementById('score-note');
if (mode === 'raw') {
    scoreNote.classList.add('show');
} else {
    scoreNote.classList.remove('show');
}

// å…¨ã¦ã®å¾—ç‚¹è¡¨ç¤ºã‚’æ›´æ–°
updateAllDomainScores();

debugLog(`è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚’${mode}ã«åˆ‡ã‚Šæ›¿ãˆ`);
}

// å…¨é ˜åŸŸå¾—ç‚¹æ›´æ–°
function updateAllDomainScores() {
document.querySelectorAll('.t-score[data-domain-key]').forEach(element => {
    const domainKey = element.getAttribute('data-domain-key');
    updateDomainScore(element, domainKey);
});
}

// é ˜åŸŸå¾—ç‚¹æ›´æ–°
function updateDomainScore(element, domainKey) {
const tScore = results.tScores.domains[domainKey];
const rawScore = results.rawScores.domains[domainKey];

if (currentDisplayMode === 'tscore') {
    element.textContent = tScore;
} else {
    element.textContent = rawScore;
}
}

// é ˜åŸŸèª¬æ˜ã®å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
function toggleDomainDescription(row, domainKey) {
const descRow = row.nextElementSibling;
const descCell = descRow.querySelector('.domain-description');
const expandIcon = row.querySelector('.expand-icon');

if (descCell.classList.contains('expanded')) {
    descCell.classList.remove('expanded');
    row.classList.remove('expanded');
    if (expandIcon) {
        expandIcon.classList.remove('expanded');
    }
} else {
    descCell.classList.add('expanded');
    row.classList.add('expanded');
    if (expandIcon) {
        expandIcon.classList.add('expanded');
    }
}
}

// è©•ä¾¡ãƒ©ãƒ™ãƒ«ã®CSSã‚¯ãƒ©ã‚¹ã‚’å–å¾—
function getEvaluationClass(label) {
const classMap = {
    'éå¸¸ã«é«˜ã„': 'very-high',
    'é«˜ã„': 'high',
    'ã‚„ã‚„é«˜ã„': 'somewhat-high',
    'å¹³å‡': 'average',
    'ã‚„ã‚„ä½ã„': 'somewhat-low',
    'ä½ã„': 'low',
    'éå¸¸ã«ä½ã„': 'very-low'
};
return classMap[label] || 'average';
}

// çµæœã‚³ãƒ”ãƒ¼
function copyResults() {
try {
    const summary = scoringSystem.generateSummary(results);
    
    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
    navigator.clipboard.writeText(summary).then(() => {
        alert('çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        debugLog('çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼');
    }).catch(() => {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ä½¿ç”¨
        const textArea = document.createElement('textarea');
        textArea.value = summary;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        debugLog('çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰');
    });
} catch (error) {
    debugLog(`ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
}
}

// ç¢ºèªä»˜ãã§æœ€åˆã«æˆ»ã‚‹
function confirmReturnToStart() {
const confirmed = confirm('æœ¬å½“ã«çµæœç”»é¢ã‹ã‚‰ç§»å‹•ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');
if (confirmed) {
    window.location.href = 'index.html';
}
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
window.addEventListener('load', initialize);
</script>
</body>
</html>