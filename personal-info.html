<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPIP-NEO-120 æ€§æ ¼ãƒ†ã‚¹ãƒˆ - å€‹äººæƒ…å ±å…¥åŠ›</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
            line-height: 1.6;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .completion-message {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .completion-emoji {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .completion-title {
            font-size: 24px;
            color: #27ae60;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .completion-text {
            color: #2c3e50;
            font-size: 16px;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-title {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .data-notice {
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 12px 16px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .data-notice-text {
            font-size: 14px;
            color: #5a6c7d;
            margin: 0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #34495e;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 8px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
        }
        
        .radio-option input[type="radio"] {
            margin-right: 8px;
        }
        
        .submit-button {
            width: 100%;
            background-color: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            position: relative;
        }
        
        .submit-button:hover {
            background-color: #2980b9;
        }
        
        .submit-button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .loading-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .loading-subtext {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        /* ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒªã‚¢ */
        .debug-area {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .debug-title {
            font-weight: bold;
            color: #6c757d;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .debug-content {
            font-family: monospace;
            font-size: 12px;
            background-color: white;
            padding: 10px;
            border-radius: 3px;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">çµæœã‚’è¨ˆç®—ä¸­...</div>
            <div class="loading-subtext" id="loading-subtext">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</div>
        </div>
    </div>

    <div class="container">
        <!-- å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div class="completion-message">
            <div class="completion-emoji">ğŸ‰</div>
            <div class="completion-title">ãƒ†ã‚¹ãƒˆå®Œäº†ï¼</div>
            <div class="completion-text">120å•ã®å›ç­”ãŠç–²ã‚Œã•ã¾ã§ã—ãŸ</div>
        </div>
        
        <!-- ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="form-section">
            <div class="form-title">çµæœã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«åŸºæœ¬æƒ…å ±ã‚’ã”å…¥åŠ›ãã ã•ã„</div>
            
            <!-- ãƒ‡ãƒ¼ã‚¿åˆ©ç”¨ã«é–¢ã™ã‚‹æ³¨æ„æ›¸ã -->
            <div class="data-notice">
                <p class="data-notice-text">â€» åŒ¿åå›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’çµ±è¨ˆç›®çš„ã§ä½¿ç”¨ã—ã¾ã™</p>
            </div>
            
            <form id="personal-info-form">
                <!-- æ€§åˆ¥ -->
                <div class="form-group">
                    <label class="form-label">æ€§åˆ¥</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="male" name="gender" value="ç”·æ€§">
                            <label for="male">ç”·æ€§</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="female" name="gender" value="å¥³æ€§">
                            <label for="female">å¥³æ€§</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="other" name="gender" value="ãã®ä»–">
                            <label for="other">ãã®ä»–</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="no-answer" name="gender" value="å›ç­”ã—ãªã„">
                            <label for="no-answer">å›ç­”ã—ãªã„</label>
                        </div>
                    </div>
                </div>
                
                <!-- å¹´é½¢ -->
                <div class="form-group">
                    <label class="form-label" for="age">å¹´é½¢</label>
                    <input type="number" id="age" name="age" class="form-control" min="10" max="100" placeholder="ä¾‹: 25">
                </div>
                
                <!-- å›½ç± -->
                <div class="form-group">
                    <label class="form-label" for="nationality">å›½ç±</label>
                    <input type="text" id="nationality" name="nationality" class="form-control" placeholder="ä¾‹: æ—¥æœ¬" value="æ—¥æœ¬">
                </div>
                
                <button type="submit" class="submit-button" id="submit-button">çµæœã‚’è¦‹ã‚‹</button>
            </form>
        </div>
        
        <!-- ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒªã‚¢ -->
        <div class="debug-area">
            <div class="debug-title">ãƒ‡ãƒãƒƒã‚°æƒ…å ±</div>
            <div class="debug-content" id="debug-content">å€‹äººæƒ…å ±å…¥åŠ›ç”»é¢ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ...</div>
        </div>
    </div>

    <!-- æ¡ç‚¹ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿ -->
    <script src="scoring.js"></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let answers = [];
        let personalInfo = {};
        let results = null;
        let scoringSystem = null;

        // Google Formsè¨­å®š
        const GOOGLE_FORMS_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSccj4oGnOjRDkCv6cZlnbsb3X78EOdjbLZpobEsO5uh_6ZbOQ/formResponse';
        
        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰IDï¼ˆç¢ºèªæ¸ˆã¿5é …ç›® + ä»–189é …ç›®ã¯é †æ¬¡è¿½åŠ ï¼‰
        const FORM_FIELDS = {
            // åŸºæœ¬æƒ…å ±ï¼ˆç¢ºèªæ¸ˆã¿ï¼‰
            gender: 'entry.1080777117',
            age: 'entry.970877000',
            nationality: 'entry.1629171835',
            
            // Tå¾—ç‚¹ï¼ˆ5é ˜åŸŸï¼‰- ç¢ºèªæ¸ˆã¿2é …ç›®
            neuroticism_t: 'entry.271264077',
            extraversion_t: 'entry.360087731',
            openness_t: 'entry.XXXXX1', // è¦ç¢ºèª
            agreeableness_t: 'entry.XXXXX2', // è¦ç¢ºèª
            conscientiousness_t: 'entry.XXXXX3', // è¦ç¢ºèª
            
            // æ®‹ã‚Š189é …ç›®ã¯æ®µéšçš„ã«è¿½åŠ äºˆå®š
            // Tå¾—ç‚¹ï¼ˆ30å´é¢ï¼‰
            // è³ªå•å›ç­”ï¼ˆ120å•ï¼‰
            // ç”Ÿå¾—ç‚¹ï¼ˆ35é …ç›®ï¼‰
        };

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
        function debugLog(message) {
            const debugContent = document.getElementById('debug-content');
            const timestamp = new Date().toLocaleTimeString();
            debugContent.textContent += `[${timestamp}] ${message}\n`;
            debugContent.scrollTop = debugContent.scrollHeight;
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ¶å¾¡
        function showLoading(text = 'çµæœã‚’è¨ˆç®—ä¸­...', subtext = 'ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-subtext').textContent = subtext;
            document.getElementById('loading-overlay').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // åˆæœŸåŒ–
        function initialize() {
            debugLog('å€‹äººæƒ…å ±å…¥åŠ›ç”»é¢ã‚’åˆæœŸåŒ–ä¸­...');
            
            // localStorageã‹ã‚‰å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            loadAnswersFromStorage();
            
            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
            const form = document.getElementById('personal-info-form');
            form.addEventListener('submit', handleFormSubmit);
            
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©æ—§æ™‚ã®è‡ªå‹•å†é€ä¿¡
            window.addEventListener('online', retryPendingSubmissions);
            window.addEventListener('focus', retryPendingSubmissions);
            
            debugLog('âœ… åˆæœŸåŒ–å®Œäº†');
        }

        // å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        function loadAnswersFromStorage() {
            try {
                const storedAnswers = localStorage.getItem('ipip-neo-answers');
                if (storedAnswers) {
                    answers = JSON.parse(storedAnswers);
                    debugLog(`âœ… å›ç­”ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿: ${answers.length}å•åˆ†`);
                    
                    // 120å•ã™ã¹ã¦å›ç­”ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const answeredCount = answers.filter(answer => answer !== undefined && answer !== null).length;
                    if (answeredCount < 120) {
                        debugLog(`âš ï¸ å›ç­”ä¸å®Œå…¨: ${answeredCount}/120å•`);
                    }
                } else {
                    debugLog('âŒ å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    // ãƒ†ã‚¹ãƒˆç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
                    answers = new Array(120).fill(0).map(() => Math.floor(Math.random() * 5) + 1);
                    debugLog('ğŸ”§ ãƒ†ã‚¹ãƒˆç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ');
                }
            } catch (error) {
                debugLog(`âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
                answers = new Array(120).fill(0).map(() => Math.floor(Math.random() * 5) + 1);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        async function loadData() {
            debugLog('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');

            // questions.json
            const questionsResponse = await fetch('./data/questions.json');
            if (!questionsResponse.ok) {
                throw new Error(`questions.jsonèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${questionsResponse.status}`);
            }
            const questionsData = await questionsResponse.json();

            // norms.json
            const normsResponse = await fetch('./data/norms.json');
            if (!normsResponse.ok) {
                throw new Error(`norms.jsonèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${normsResponse.status}`);
            }
            const normsData = await normsResponse.json();

            // æ¡ç‚¹ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
            scoringSystem = new IPIPNEOScoring(normsData, questionsData);

            debugLog('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
        }

        // æ¡ç‚¹å®Ÿè¡Œ
        function calculateResults() {
            debugLog('æ¡ç‚¹ã‚’å®Ÿè¡Œä¸­...');
            
            try {
                results = scoringSystem.calculateFullResults(answers);
                debugLog('âœ… æ¡ç‚¹å®Œäº†');
                
            } catch (error) {
                debugLog(`âŒ æ¡ç‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                throw error;
            }
        }

        // Google Formsã«é€ä¿¡ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
        async function submitToGoogleForms(retryCount = 0) {
            const maxRetries = 3;
            
            try {
                debugLog(`Google Formsé€ä¿¡è©¦è¡Œ ${retryCount + 1}/${maxRetries + 1}`);
                
                const formData = new FormData();
                
                // åŸºæœ¬æƒ…å ±
                formData.append(FORM_FIELDS.gender, personalInfo.gender);
                formData.append(FORM_FIELDS.age, personalInfo.age.toString());
                formData.append(FORM_FIELDS.nationality, personalInfo.nationality);
                
                // Tå¾—ç‚¹ï¼ˆç¾åœ¨ç¢ºèªæ¸ˆã¿ã®5é …ç›®ã®ã¿é€ä¿¡ï¼‰
                formData.append(FORM_FIELDS.neuroticism_t, results.tScores.domains.Neuroticism.toString());
                formData.append(FORM_FIELDS.extraversion_t, results.tScores.domains.Extraversion.toString());
                
                // æ®‹ã‚Šã®é …ç›®ã¯æ®µéšçš„ã«è¿½åŠ äºˆå®š
                // formData.append(FORM_FIELDS.openness_t, results.tScores.domains.Openness.toString());
                // formData.append(FORM_FIELDS.agreeableness_t, results.tScores.domains.Agreeableness.toString());
                // formData.append(FORM_FIELDS.conscientiousness_t, results.tScores.domains.Conscientiousness.toString());
                
                // è³ªå•å›ç­”ï¼ˆ120å•ï¼‰- ç¾åœ¨ã¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰IDæœªç¢ºèªã®ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
                /*
                answers.forEach((answer, index) => {
                    const fieldKey = `q${index + 1}`;
                    if (FORM_FIELDS[fieldKey]) {
                        formData.append(FORM_FIELDS[fieldKey], answer.toString());
                    }
                });
                */
                
                // é€ä¿¡å®Ÿè¡Œ
                const response = await fetch(GOOGLE_FORMS_URL, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors'
                });
                
                debugLog('âœ… Google Formsé€ä¿¡æˆåŠŸ');
                
                // æˆåŠŸæ™‚ã¯ä¿ç•™ä¸­ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                clearPendingSubmission();
                
                return true;
                
            } catch (error) {
                debugLog(`âŒ é€ä¿¡å¤±æ•— (è©¦è¡Œ${retryCount + 1}): ${error.message}`);
                
                if (retryCount < maxRetries) {
                    // ãƒªãƒˆãƒ©ã‚¤
                    await sleep(1000 * (retryCount + 1)); // 1ç§’ã€2ç§’ã€3ç§’å¾…æ©Ÿ
                    return await submitToGoogleForms(retryCount + 1);
                } else {
                    // æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«é”ã—ãŸå ´åˆ
                    debugLog('âŒ æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«é”ã—ã¾ã—ãŸ');
                    
                    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜
                    saveToLocalBackup();
                    
                    return false;
                }
            }
        }

        // æ®µéšçš„ãƒªãƒˆãƒ©ã‚¤ï¼ˆå³åº§â†’5ç§’å¾Œâ†’10ç§’å¾Œï¼‰
        async function submitWithAdvancedRetry() {
            // ç¬¬1æ®µéšï¼šå³åº§ã«3å›ãƒªãƒˆãƒ©ã‚¤
            for (let i = 0; i < 3; i++) {
                if (await submitToGoogleForms(i)) return true;
            }
            
            // ç¬¬2æ®µéšï¼š5ç§’å¾…ã£ã¦2å›ãƒªãƒˆãƒ©ã‚¤
            debugLog('5ç§’å¾Œã«å†é€ä¿¡ã‚’è©¦è¡Œã—ã¾ã™...');
            await sleep(5000);
            for (let i = 0; i < 2; i++) {
                if (await submitToGoogleForms(i + 3)) return true;
            }
            
            // ç¬¬3æ®µéšï¼š10ç§’å¾…ã£ã¦æœ€å¾Œã®1å›
            debugLog('10ç§’å¾Œã«æœ€çµ‚é€ä¿¡ã‚’è©¦è¡Œã—ã¾ã™...');
            await sleep(10000);
            return await submitToGoogleForms(5);
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’localStorageã«ä¿å­˜
        function saveToLocalBackup() {
            try {
                const backupData = {
                    personalInfo: personalInfo,
                    answers: answers,
                    results: results,
                    timestamp: new Date().toISOString(),
                    submitted: false
                };
                
                localStorage.setItem('ipip-neo-backup-' + Date.now(), JSON.stringify(backupData));
                debugLog('ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                
            } catch (error) {
                debugLog(`âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ä¿ç•™ä¸­ã®é€ä¿¡ã‚’å†è©¦è¡Œ
        async function retryPendingSubmissions() {
            debugLog('ä¿ç•™ä¸­ã®é€ä¿¡ã‚’ç¢ºèªä¸­...');
            
            const keys = Object.keys(localStorage);
            const backupKeys = keys.filter(key => key.startsWith('ipip-neo-backup-'));
            
            for (const key of backupKeys) {
                try {
                    const backupData = JSON.parse(localStorage.getItem(key));
                    if (!backupData.submitted) {
                        debugLog('ä¿ç•™ä¸­ãƒ‡ãƒ¼ã‚¿ã‚’ç™ºè¦‹ã€å†é€ä¿¡ã‚’è©¦è¡Œ...');
                        
                        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’å¾©å…ƒ
                        personalInfo = backupData.personalInfo;
                        answers = backupData.answers;
                        results = backupData.results;
                        
                        // å†é€ä¿¡
                        if (await submitToGoogleForms()) {
                            localStorage.removeItem(key);
                            debugLog('âœ… ä¿ç•™ä¸­ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡å®Œäº†');
                        }
                    }
                } catch (error) {
                    debugLog(`âŒ ä¿ç•™ä¸­ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            }
        }

        // é€ä¿¡æˆåŠŸæ™‚ã®ä¿ç•™ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearPendingSubmission() {
            const keys = Object.keys(localStorage);
            const backupKeys = keys.filter(key => key.startsWith('ipip-neo-backup-'));
            backupKeys.forEach(key => {
                localStorage.removeItem(key);
            });
        }

        // å¾…æ©Ÿé–¢æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            debugLog('ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡é–‹å§‹...');
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—
            const formData = new FormData(event.target);
            personalInfo = {
                gender: formData.get('gender'),
                age: parseInt(formData.get('age')),
                nationality: formData.get('nationality')
            };
            
            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!personalInfo.gender) {
                alert('æ€§åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!personalInfo.age || personalInfo.age < 10 || personalInfo.age > 100) {
                alert('å¹´é½¢ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ10-100æ­³ï¼‰');
                return;
            }
            
            if (!personalInfo.nationality || personalInfo.nationality.trim() === '') {
                alert('å›½ç±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            debugLog(`å€‹äººæƒ…å ±: ${personalInfo.gender}, ${personalInfo.age}æ­³, ${personalInfo.nationality}`);
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            showLoading('çµæœã‚’è¨ˆç®—ä¸­...', 'ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„');
            
            try {
                // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
                await loadData();
                
                // æ¡ç‚¹å®Ÿè¡Œ
                calculateResults();
                
                // å€‹äººæƒ…å ±ã‚’localStorageã«ä¿å­˜
                savePersonalInfo();
                
                // Google Formsã«é€ä¿¡ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
                showLoading('ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ä¸­...', 'çµæœè¨ˆç®—ã¯å®Œäº†ã—ã¦ã„ã¾ã™');
                
                const submitSuccess = await submitWithAdvancedRetry();
                
                if (submitSuccess) {
                    debugLog('âœ… ãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Œäº†');
                } else {
                    debugLog('âš ï¸ ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã¯å¤±æ•—ã—ã¾ã—ãŸãŒã€çµæœã¯è¡¨ç¤ºã•ã‚Œã¾ã™');
                }
                
            } catch (error) {
                debugLog(`âŒ å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€çµæœã¯è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚');
            } finally {
                // æˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšçµæœç”»é¢ã«é·ç§»
                hideLoading();
                goToResults();
            }
        }

        // å€‹äººæƒ…å ±ã‚’localStorageã«ä¿å­˜
        function savePersonalInfo() {
            try {
                localStorage.setItem('ipip-neo-personal-info', JSON.stringify(personalInfo));
                debugLog('âœ… å€‹äººæƒ…å ±ã‚’ä¿å­˜');
            } catch (error) {
                debugLog(`âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // çµæœç”»é¢ã«é·ç§»
        function goToResults() {
            debugLog('çµæœç”»é¢ã«é·ç§»...');
            window.location.href = 'results.html';
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('load', initialize);
    </script>
</body>
</html>